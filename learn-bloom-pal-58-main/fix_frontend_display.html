<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯æ•°æ®æ˜¾ç¤ºä¿®å¤å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .danger { background: #dc3545; }
        .danger:hover { background: #c82333; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 300px; }
        .data-item { margin: 5px 0; padding: 8px; background: #f8f9fa; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ å‰ç«¯æ•°æ®æ˜¾ç¤ºä¿®å¤å·¥å…·</h1>
    
    <div class="section info">
        <h3>ğŸ“Š æ•°æ®çŠ¶æ€æ£€æŸ¥</h3>
        <p>é¦–å…ˆæ£€æŸ¥æ•°æ®åº“ä¸­çš„å®é™…æ•°æ®çŠ¶æ€</p>
        <button onclick="checkDatabaseData()">æ£€æŸ¥æ•°æ®åº“æ•°æ®</button>
        <div id="database-status"></div>
    </div>
    
    <div class="section">
        <h3>ğŸ” ç”¨æˆ·è®¤è¯çŠ¶æ€</h3>
        <button onclick="checkAuthStatus()">æ£€æŸ¥è®¤è¯çŠ¶æ€</button>
        <button onclick="loginAsAdmin()">ç®¡ç†å‘˜ç™»å½•</button>
        <button onclick="logout()">é€€å‡ºç™»å½•</button>
        <div id="auth-status"></div>
    </div>
    
    <div class="section">
        <h3>ğŸ”„ ç¼“å­˜æ¸…ç†</h3>
        <p>æ¸…ç†å¯èƒ½å¯¼è‡´æ•°æ®æ˜¾ç¤ºé—®é¢˜çš„ç¼“å­˜</p>
        <button onclick="clearLocalStorage()">æ¸…é™¤æœ¬åœ°å­˜å‚¨</button>
        <button onclick="clearSessionStorage()">æ¸…é™¤ä¼šè¯å­˜å‚¨</button>
        <button onclick="clearAllCache()">æ¸…é™¤æ‰€æœ‰ç¼“å­˜</button>
        <div id="cache-status"></div>
    </div>
    
    <div class="section">
        <h3>ğŸ“¡ APIæµ‹è¯•</h3>
        <p>æµ‹è¯•å‰ç«¯APIè°ƒç”¨æ˜¯å¦æ­£å¸¸</p>
        <button onclick="testCourseAPI()">æµ‹è¯•è¯¾ç¨‹API</button>
        <button onclick="testAssignmentAPI()">æµ‹è¯•ä½œä¸šAPI</button>
        <button onclick="testSessionAPI()">æµ‹è¯•æœŸæ¬¡API</button>
        <div id="api-status"></div>
    </div>
    
    <div class="section">
        <h3>ğŸš€ å¿«é€Ÿä¿®å¤</h3>
        <button onclick="quickFix()" class="danger">ä¸€é”®ä¿®å¤æ‰€æœ‰é—®é¢˜</button>
        <button onclick="openMainSite()">æ‰“å¼€ä¸»ç«™</button>
        <div id="fix-status"></div>
    </div>
    
    <div id="results"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://upwrgkhpuwxkbwndxxxs.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwd3Jna2hwdXd4a2J3bmR4eHhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MzU4NzgsImV4cCI6MjA3MjMxMTg3OH0.NyJFFUG5B72cw99TAkmJMifxCM9tAKVN8OrCTBuHwAo'
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)
        
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId)
            element.innerHTML = `<div class="${type}" style="margin-top: 10px; padding: 10px; border-radius: 4px;">${message}</div>`
        }
        
        async function checkDatabaseData() {
            showResult('database-status', 'æ­£åœ¨æ£€æŸ¥æ•°æ®åº“æ•°æ®...', 'info')
            try {
                const [coursesRes, assignmentsRes, sessionsRes] = await Promise.all([
                    supabase.from('courses').select('*'),
                    supabase.from('assignments').select('*'),
                    supabase.from('training_sessions').select('*')
                ])
                
                let html = '<h4>æ•°æ®åº“æ•°æ®çŠ¶æ€:</h4>'
                html += `<div class="data-item">ğŸ“š è¯¾ç¨‹: ${coursesRes.data?.length || 0} ä¸ª</div>`
                html += `<div class="data-item">ğŸ“‹ ä½œä¸š: ${assignmentsRes.data?.length || 0} ä¸ª</div>`
                html += `<div class="data-item">ğŸ¯ æœŸæ¬¡: ${sessionsRes.data?.length || 0} ä¸ª</div>`
                
                if (coursesRes.data?.length > 0) {
                    html += '<h5>è¯¾ç¨‹åˆ—è¡¨:</h5>'
                    coursesRes.data.forEach((course, i) => {
                        html += `<div class="data-item">${i+1}. ${course.title}</div>`
                    })
                }
                
                showResult('database-status', html, 'success')
            } catch (error) {
                showResult('database-status', `æ•°æ®æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error')
            }
        }
        
        async function checkAuthStatus() {
            try {
                const { data: { user } } = await supabase.auth.getUser()
                if (user) {
                    showResult('auth-status', `âœ… å·²ç™»å½•: ${user.email} (ID: ${user.id})`, 'success')
                } else {
                    showResult('auth-status', 'âŒ æœªç™»å½•', 'error')
                }
            } catch (error) {
                showResult('auth-status', `è®¤è¯æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error')
            }
        }
        
        async function loginAsAdmin() {
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'admin@example.com',
                    password: 'admin123'
                })
                
                if (error) {
                    showResult('auth-status', `ç™»å½•å¤±è´¥: ${error.message}`, 'error')
                } else {
                    showResult('auth-status', `âœ… ç™»å½•æˆåŠŸ: ${data.user.email}`, 'success')
                }
            } catch (error) {
                showResult('auth-status', `ç™»å½•å¼‚å¸¸: ${error.message}`, 'error')
            }
        }
        
        async function logout() {
            try {
                await supabase.auth.signOut()
                showResult('auth-status', 'âœ… å·²é€€å‡ºç™»å½•', 'success')
            } catch (error) {
                showResult('auth-status', `é€€å‡ºå¤±è´¥: ${error.message}`, 'error')
            }
        }
        
        function clearLocalStorage() {
            localStorage.clear()
            showResult('cache-status', 'âœ… æœ¬åœ°å­˜å‚¨å·²æ¸…é™¤', 'success')
        }
        
        function clearSessionStorage() {
            sessionStorage.clear()
            showResult('cache-status', 'âœ… ä¼šè¯å­˜å‚¨å·²æ¸…é™¤', 'success')
        }
        
        function clearAllCache() {
            localStorage.clear()
            sessionStorage.clear()
            // æ¸…é™¤ Supabase ç›¸å…³ç¼“å­˜
            const keys = Object.keys(localStorage)
            keys.forEach(key => {
                if (key.includes('supabase') || key.includes('auth')) {
                    localStorage.removeItem(key)
                }
            })
            showResult('cache-status', 'âœ… æ‰€æœ‰ç¼“å­˜å·²æ¸…é™¤ï¼Œå»ºè®®åˆ·æ–°é¡µé¢', 'success')
        }
        
        async function testCourseAPI() {
            try {
                const { data, error } = await supabase.from('courses').select('*')
                if (error) {
                    showResult('api-status', `è¯¾ç¨‹APIé”™è¯¯: ${error.message}`, 'error')
                } else {
                    showResult('api-status', `âœ… è¯¾ç¨‹APIæ­£å¸¸ï¼Œè¿”å› ${data.length} ä¸ªè¯¾ç¨‹`, 'success')
                }
            } catch (error) {
                showResult('api-status', `è¯¾ç¨‹APIå¼‚å¸¸: ${error.message}`, 'error')
            }
        }
        
        async function testAssignmentAPI() {
            try {
                const { data, error } = await supabase.from('assignments').select('*')
                if (error) {
                    showResult('api-status', `ä½œä¸šAPIé”™è¯¯: ${error.message}`, 'error')
                } else {
                    showResult('api-status', `âœ… ä½œä¸šAPIæ­£å¸¸ï¼Œè¿”å› ${data.length} ä¸ªä½œä¸š`, 'success')
                }
            } catch (error) {
                showResult('api-status', `ä½œä¸šAPIå¼‚å¸¸: ${error.message}`, 'error')
            }
        }
        
        async function testSessionAPI() {
            try {
                const { data, error } = await supabase.from('training_sessions').select('*')
                if (error) {
                    showResult('api-status', `æœŸæ¬¡APIé”™è¯¯: ${error.message}`, 'error')
                } else {
                    showResult('api-status', `âœ… æœŸæ¬¡APIæ­£å¸¸ï¼Œè¿”å› ${data.length} ä¸ªæœŸæ¬¡`, 'success')
                }
            } catch (error) {
                showResult('api-status', `æœŸæ¬¡APIå¼‚å¸¸: ${error.message}`, 'error')
            }
        }
        
        async function quickFix() {
            showResult('fix-status', 'ğŸ”§ å¼€å§‹å¿«é€Ÿä¿®å¤...', 'info')
            
            // 1. æ¸…é™¤æ‰€æœ‰ç¼“å­˜
            clearAllCache()
            
            // 2. é‡æ–°ç™»å½•
            try {
                await supabase.auth.signOut()
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'admin@example.com',
                    password: 'admin123'
                })
                
                if (error) {
                    showResult('fix-status', `ä¿®å¤å¤±è´¥: ${error.message}`, 'error')
                    return
                }
            } catch (error) {
                showResult('fix-status', `ä¿®å¤å¼‚å¸¸: ${error.message}`, 'error')
                return
            }
            
            // 3. æµ‹è¯•æ•°æ®è®¿é—®
            try {
                const [coursesRes, assignmentsRes, sessionsRes] = await Promise.all([
                    supabase.from('courses').select('*'),
                    supabase.from('assignments').select('*'),
                    supabase.from('training_sessions').select('*')
                ])
                
                let message = 'âœ… å¿«é€Ÿä¿®å¤å®Œæˆï¼<br>'
                message += `ğŸ“š è¯¾ç¨‹: ${coursesRes.data?.length || 0} ä¸ª<br>`
                message += `ğŸ“‹ ä½œä¸š: ${assignmentsRes.data?.length || 0} ä¸ª<br>`
                message += `ğŸ¯ æœŸæ¬¡: ${sessionsRes.data?.length || 0} ä¸ª<br>`
                message += '<br>ğŸ”„ è¯·åˆ·æ–°ä¸»ç«™é¡µé¢æŸ¥çœ‹æ•°æ®'
                
                showResult('fix-status', message, 'success')
            } catch (error) {
                showResult('fix-status', `æ•°æ®æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
            }
        }
        
        function openMainSite() {
            window.open('http://localhost:3002', '_blank')
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            checkDatabaseData()
            checkAuthStatus()
        }
    </script>
</body>
</html>