<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前端API连接修复工具</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .danger { background: #dc3545; }
        .danger:hover { background: #c82333; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 300px; }
        .status-item { margin: 5px 0; padding: 8px; background: #f8f9fa; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>🔧 前端API连接修复工具</h1>
    
    <div class="section info">
        <h3>📊 问题诊断</h3>
        <p>检测到前端无法连接到后端API (localhost:3000)，但后端服务正在正常运行。</p>
        <p><strong>可能原因：</strong></p>
        <ul>
            <li>浏览器缓存了失败的请求</li>
            <li>前端用户角色状态异常</li>
            <li>CORS配置问题</li>
            <li>网络请求被拦截</li>
        </ul>
    </div>
    
    <div class="section">
        <h3>🔍 连接测试</h3>
        <button onclick="testBackendConnection()">测试后端连接</button>
        <button onclick="testApiEndpoints()">测试API端点</button>
        <div id="connection-status"></div>
    </div>
    
    <div class="section">
        <h3>👤 用户状态检查</h3>
        <button onclick="checkUserRole()">检查用户角色</button>
        <button onclick="setAdminRole()">设置管理员角色</button>
        <button onclick="clearUserRole()">清除用户角色</button>
        <div id="user-status"></div>
    </div>
    
    <div class="section">
        <h3>🔄 缓存清理</h3>
        <button onclick="clearBrowserCache()">清除浏览器缓存</button>
        <button onclick="clearLocalStorage()">清除本地存储</button>
        <button onclick="forceRefresh()">强制刷新页面</button>
        <div id="cache-status"></div>
    </div>
    
    <div class="section">
        <h3>🚀 一键修复</h3>
        <button onclick="quickFix()" class="danger">一键修复所有问题</button>
        <button onclick="openMainSite()">打开主站测试</button>
        <div id="fix-status"></div>
    </div>

    <script>
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId)
            element.innerHTML = `<div class="${type}" style="margin-top: 10px; padding: 10px; border-radius: 4px;">${message}</div>`
        }
        
        async function testBackendConnection() {
            showResult('connection-status', '正在测试后端连接...', 'info')
            
            try {
                // 测试健康检查端点
                const healthRes = await fetch('http://localhost:3000/health')
                const healthData = await healthRes.json()
                
                let html = '<h4>后端连接测试结果:</h4>'
                html += `<div class="status-item">✅ 健康检查: ${healthData.status} (${healthData.service})</div>`
                
                // 测试API端点
                const apiRes = await fetch('http://localhost:3000/api/training-sessions')
                if (apiRes.ok) {
                    const apiData = await apiRes.json()
                    html += `<div class="status-item">✅ API端点: 正常 (返回${apiData.length}条记录)</div>`
                } else {
                    html += `<div class="status-item">❌ API端点: 错误 ${apiRes.status}</div>`
                }
                
                showResult('connection-status', html, 'success')
            } catch (error) {
                showResult('connection-status', `❌ 连接失败: ${error.message}`, 'error')
            }
        }
        
        async function testApiEndpoints() {
            showResult('connection-status', '正在测试所有API端点...', 'info')
            
            const endpoints = [
                '/api/training-sessions',
                '/api/training-sessions/current',
                '/api/courses'
            ]
            
            let html = '<h4>API端点测试结果:</h4>'
            
            for (const endpoint of endpoints) {
                try {
                    const res = await fetch(`http://localhost:3000${endpoint}`)
                    if (res.ok) {
                        html += `<div class="status-item">✅ ${endpoint}: 正常 (${res.status})</div>`
                    } else {
                        html += `<div class="status-item">❌ ${endpoint}: 错误 ${res.status}</div>`
                    }
                } catch (error) {
                    html += `<div class="status-item">❌ ${endpoint}: 连接失败 - ${error.message}</div>`
                }
            }
            
            showResult('connection-status', html, 'success')
        }
        
        function checkUserRole() {
            const role = localStorage.getItem('user_role')
            const userId = localStorage.getItem('user_id')
            const userEmail = localStorage.getItem('user_email')
            
            let html = '<h4>用户状态:</h4>'
            html += `<div class="status-item">角色: ${role || '未设置'}</div>`
            html += `<div class="status-item">用户ID: ${userId || '未设置'}</div>`
            html += `<div class="status-item">邮箱: ${userEmail || '未设置'}</div>`
            
            const type = role === 'admin' ? 'success' : 'warning'
            showResult('user-status', html, type)
        }
        
        function setAdminRole() {
            localStorage.setItem('user_role', 'admin')
            localStorage.setItem('user_email', 'admin@example.com')
            localStorage.setItem('user_id', 'admin-user-id')
            showResult('user-status', '✅ 已设置为管理员角色', 'success')
        }
        
        function clearUserRole() {
            localStorage.removeItem('user_role')
            localStorage.removeItem('user_email')
            localStorage.removeItem('user_id')
            showResult('user-status', '✅ 已清除用户角色', 'success')
        }
        
        function clearBrowserCache() {
            // 清除浏览器缓存（通过添加时间戳强制刷新）
            const timestamp = Date.now()
            window.location.href = window.location.href.split('?')[0] + '?t=' + timestamp
        }
        
        function clearLocalStorage() {
            const keysToKeep = ['user_role', 'user_email', 'user_id'] // 保留用户信息
            const allKeys = Object.keys(localStorage)
            
            allKeys.forEach(key => {
                if (!keysToKeep.includes(key)) {
                    localStorage.removeItem(key)
                }
            })
            
            showResult('cache-status', '✅ 本地存储已清理（保留用户信息）', 'success')
        }
        
        function forceRefresh() {
            window.location.reload(true)
        }
        
        async function quickFix() {
            showResult('fix-status', '🔧 开始一键修复...', 'info')
            
            let steps = []
            
            // 1. 设置管理员角色
            localStorage.setItem('user_role', 'admin')
            localStorage.setItem('user_email', 'admin@example.com')
            localStorage.setItem('user_id', 'admin-user-id')
            steps.push('✅ 设置管理员角色')
            
            // 2. 清理缓存
            sessionStorage.clear()
            const allKeys = Object.keys(localStorage)
            const keysToKeep = ['user_role', 'user_email', 'user_id']
            allKeys.forEach(key => {
                if (!keysToKeep.includes(key)) {
                    localStorage.removeItem(key)
                }
            })
            steps.push('✅ 清理缓存')
            
            // 3. 测试连接
            try {
                const res = await fetch('http://localhost:3000/health')
                if (res.ok) {
                    steps.push('✅ 后端连接正常')
                } else {
                    steps.push('❌ 后端连接异常')
                }
            } catch (error) {
                steps.push('❌ 后端连接失败')
            }
            
            // 4. 显示结果
            let html = '<h4>修复完成:</h4>'
            steps.forEach(step => {
                html += `<div class="status-item">${step}</div>`
            })
            html += '<br><p><strong>建议操作:</strong></p>'
            html += '<ul>'
            html += '<li>点击"打开主站测试"按钮</li>'
            html += '<li>如果问题仍然存在，请刷新浏览器页面</li>'
            html += '<li>检查浏览器控制台是否有新的错误信息</li>'
            html += '</ul>'
            
            showResult('fix-status', html, 'success')
        }
        
        function openMainSite() {
            window.open('http://localhost:3002', '_blank')
        }
        
        // 页面加载时自动检查
        window.onload = function() {
            testBackendConnection()
            checkUserRole()
        }
    </script>
</body>
</html>