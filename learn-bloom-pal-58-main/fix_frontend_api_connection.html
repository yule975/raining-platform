<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯APIè¿æ¥ä¿®å¤å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .danger { background: #dc3545; }
        .danger:hover { background: #c82333; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 300px; }
        .status-item { margin: 5px 0; padding: 8px; background: #f8f9fa; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ å‰ç«¯APIè¿æ¥ä¿®å¤å·¥å…·</h1>
    
    <div class="section info">
        <h3>ğŸ“Š é—®é¢˜è¯Šæ–­</h3>
        <p>æ£€æµ‹åˆ°å‰ç«¯æ— æ³•è¿æ¥åˆ°åç«¯API (localhost:3000)ï¼Œä½†åç«¯æœåŠ¡æ­£åœ¨æ­£å¸¸è¿è¡Œã€‚</p>
        <p><strong>å¯èƒ½åŸå› ï¼š</strong></p>
        <ul>
            <li>æµè§ˆå™¨ç¼“å­˜äº†å¤±è´¥çš„è¯·æ±‚</li>
            <li>å‰ç«¯ç”¨æˆ·è§’è‰²çŠ¶æ€å¼‚å¸¸</li>
            <li>CORSé…ç½®é—®é¢˜</li>
            <li>ç½‘ç»œè¯·æ±‚è¢«æ‹¦æˆª</li>
        </ul>
    </div>
    
    <div class="section">
        <h3>ğŸ” è¿æ¥æµ‹è¯•</h3>
        <button onclick="testBackendConnection()">æµ‹è¯•åç«¯è¿æ¥</button>
        <button onclick="testApiEndpoints()">æµ‹è¯•APIç«¯ç‚¹</button>
        <div id="connection-status"></div>
    </div>
    
    <div class="section">
        <h3>ğŸ‘¤ ç”¨æˆ·çŠ¶æ€æ£€æŸ¥</h3>
        <button onclick="checkUserRole()">æ£€æŸ¥ç”¨æˆ·è§’è‰²</button>
        <button onclick="setAdminRole()">è®¾ç½®ç®¡ç†å‘˜è§’è‰²</button>
        <button onclick="clearUserRole()">æ¸…é™¤ç”¨æˆ·è§’è‰²</button>
        <div id="user-status"></div>
    </div>
    
    <div class="section">
        <h3>ğŸ”„ ç¼“å­˜æ¸…ç†</h3>
        <button onclick="clearBrowserCache()">æ¸…é™¤æµè§ˆå™¨ç¼“å­˜</button>
        <button onclick="clearLocalStorage()">æ¸…é™¤æœ¬åœ°å­˜å‚¨</button>
        <button onclick="forceRefresh()">å¼ºåˆ¶åˆ·æ–°é¡µé¢</button>
        <div id="cache-status"></div>
    </div>
    
    <div class="section">
        <h3>ğŸš€ ä¸€é”®ä¿®å¤</h3>
        <button onclick="quickFix()" class="danger">ä¸€é”®ä¿®å¤æ‰€æœ‰é—®é¢˜</button>
        <button onclick="openMainSite()">æ‰“å¼€ä¸»ç«™æµ‹è¯•</button>
        <div id="fix-status"></div>
    </div>

    <script>
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId)
            element.innerHTML = `<div class="${type}" style="margin-top: 10px; padding: 10px; border-radius: 4px;">${message}</div>`
        }
        
        async function testBackendConnection() {
            showResult('connection-status', 'æ­£åœ¨æµ‹è¯•åç«¯è¿æ¥...', 'info')
            
            try {
                // æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹
                const healthRes = await fetch('http://localhost:3000/health')
                const healthData = await healthRes.json()
                
                let html = '<h4>åç«¯è¿æ¥æµ‹è¯•ç»“æœ:</h4>'
                html += `<div class="status-item">âœ… å¥åº·æ£€æŸ¥: ${healthData.status} (${healthData.service})</div>`
                
                // æµ‹è¯•APIç«¯ç‚¹
                const apiRes = await fetch('http://localhost:3000/api/training-sessions')
                if (apiRes.ok) {
                    const apiData = await apiRes.json()
                    html += `<div class="status-item">âœ… APIç«¯ç‚¹: æ­£å¸¸ (è¿”å›${apiData.length}æ¡è®°å½•)</div>`
                } else {
                    html += `<div class="status-item">âŒ APIç«¯ç‚¹: é”™è¯¯ ${apiRes.status}</div>`
                }
                
                showResult('connection-status', html, 'success')
            } catch (error) {
                showResult('connection-status', `âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error')
            }
        }
        
        async function testApiEndpoints() {
            showResult('connection-status', 'æ­£åœ¨æµ‹è¯•æ‰€æœ‰APIç«¯ç‚¹...', 'info')
            
            const endpoints = [
                '/api/training-sessions',
                '/api/training-sessions/current',
                '/api/courses'
            ]
            
            let html = '<h4>APIç«¯ç‚¹æµ‹è¯•ç»“æœ:</h4>'
            
            for (const endpoint of endpoints) {
                try {
                    const res = await fetch(`http://localhost:3000${endpoint}`)
                    if (res.ok) {
                        html += `<div class="status-item">âœ… ${endpoint}: æ­£å¸¸ (${res.status})</div>`
                    } else {
                        html += `<div class="status-item">âŒ ${endpoint}: é”™è¯¯ ${res.status}</div>`
                    }
                } catch (error) {
                    html += `<div class="status-item">âŒ ${endpoint}: è¿æ¥å¤±è´¥ - ${error.message}</div>`
                }
            }
            
            showResult('connection-status', html, 'success')
        }
        
        function checkUserRole() {
            const role = localStorage.getItem('user_role')
            const userId = localStorage.getItem('user_id')
            const userEmail = localStorage.getItem('user_email')
            
            let html = '<h4>ç”¨æˆ·çŠ¶æ€:</h4>'
            html += `<div class="status-item">è§’è‰²: ${role || 'æœªè®¾ç½®'}</div>`
            html += `<div class="status-item">ç”¨æˆ·ID: ${userId || 'æœªè®¾ç½®'}</div>`
            html += `<div class="status-item">é‚®ç®±: ${userEmail || 'æœªè®¾ç½®'}</div>`
            
            const type = role === 'admin' ? 'success' : 'warning'
            showResult('user-status', html, type)
        }
        
        function setAdminRole() {
            localStorage.setItem('user_role', 'admin')
            localStorage.setItem('user_email', 'admin@example.com')
            localStorage.setItem('user_id', 'admin-user-id')
            showResult('user-status', 'âœ… å·²è®¾ç½®ä¸ºç®¡ç†å‘˜è§’è‰²', 'success')
        }
        
        function clearUserRole() {
            localStorage.removeItem('user_role')
            localStorage.removeItem('user_email')
            localStorage.removeItem('user_id')
            showResult('user-status', 'âœ… å·²æ¸…é™¤ç”¨æˆ·è§’è‰²', 'success')
        }
        
        function clearBrowserCache() {
            // æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼ˆé€šè¿‡æ·»åŠ æ—¶é—´æˆ³å¼ºåˆ¶åˆ·æ–°ï¼‰
            const timestamp = Date.now()
            window.location.href = window.location.href.split('?')[0] + '?t=' + timestamp
        }
        
        function clearLocalStorage() {
            const keysToKeep = ['user_role', 'user_email', 'user_id'] // ä¿ç•™ç”¨æˆ·ä¿¡æ¯
            const allKeys = Object.keys(localStorage)
            
            allKeys.forEach(key => {
                if (!keysToKeep.includes(key)) {
                    localStorage.removeItem(key)
                }
            })
            
            showResult('cache-status', 'âœ… æœ¬åœ°å­˜å‚¨å·²æ¸…ç†ï¼ˆä¿ç•™ç”¨æˆ·ä¿¡æ¯ï¼‰', 'success')
        }
        
        function forceRefresh() {
            window.location.reload(true)
        }
        
        async function quickFix() {
            showResult('fix-status', 'ğŸ”§ å¼€å§‹ä¸€é”®ä¿®å¤...', 'info')
            
            let steps = []
            
            // 1. è®¾ç½®ç®¡ç†å‘˜è§’è‰²
            localStorage.setItem('user_role', 'admin')
            localStorage.setItem('user_email', 'admin@example.com')
            localStorage.setItem('user_id', 'admin-user-id')
            steps.push('âœ… è®¾ç½®ç®¡ç†å‘˜è§’è‰²')
            
            // 2. æ¸…ç†ç¼“å­˜
            sessionStorage.clear()
            const allKeys = Object.keys(localStorage)
            const keysToKeep = ['user_role', 'user_email', 'user_id']
            allKeys.forEach(key => {
                if (!keysToKeep.includes(key)) {
                    localStorage.removeItem(key)
                }
            })
            steps.push('âœ… æ¸…ç†ç¼“å­˜')
            
            // 3. æµ‹è¯•è¿æ¥
            try {
                const res = await fetch('http://localhost:3000/health')
                if (res.ok) {
                    steps.push('âœ… åç«¯è¿æ¥æ­£å¸¸')
                } else {
                    steps.push('âŒ åç«¯è¿æ¥å¼‚å¸¸')
                }
            } catch (error) {
                steps.push('âŒ åç«¯è¿æ¥å¤±è´¥')
            }
            
            // 4. æ˜¾ç¤ºç»“æœ
            let html = '<h4>ä¿®å¤å®Œæˆ:</h4>'
            steps.forEach(step => {
                html += `<div class="status-item">${step}</div>`
            })
            html += '<br><p><strong>å»ºè®®æ“ä½œ:</strong></p>'
            html += '<ul>'
            html += '<li>ç‚¹å‡»"æ‰“å¼€ä¸»ç«™æµ‹è¯•"æŒ‰é’®</li>'
            html += '<li>å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·åˆ·æ–°æµè§ˆå™¨é¡µé¢</li>'
            html += '<li>æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰æ–°çš„é”™è¯¯ä¿¡æ¯</li>'
            html += '</ul>'
            
            showResult('fix-status', html, 'success')
        }
        
        function openMainSite() {
            window.open('http://localhost:3002', '_blank')
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            testBackendConnection()
            checkUserRole()
        }
    </script>
</body>
</html>