<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç´§æ€¥ç™»å½•ä¿®å¤å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
            width: 100%;
        }
        button:hover {
            background: #c82333;
        }
        .success {
            background: #28a745;
        }
        .success:hover {
            background: #1e7e34;
        }
        .warning {
            background: #ffc107;
            color: #212529;
        }
        .warning:hover {
            background: #e0a800;
        }
        .status {
            margin: 10px 0;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        .status.show {
            display: block;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .alert {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            color: #856404;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš¨ ç´§æ€¥ç™»å½•ä¿®å¤å·¥å…·</h1>
        
        <div class="alert">
            <strong>æ£€æµ‹åˆ°é—®é¢˜ï¼š</strong>ç™»å½•çŠ¶æ€ä¸ºSIGNED_INï¼Œä½†AuthContextä¸€ç›´loading: true<br>
            <strong>åŸå› ï¼š</strong>UserService.getCurrentUser()è°ƒç”¨å¡ä½
        </div>
        
        <div class="info">
            <strong>å½“å‰çŠ¶æ€ï¼š</strong><br>
            âœ… Auth state: SIGNED_IN<br>
            âš ï¸ AuthContext loading: true<br>
            âš ï¸ Profileè·å–å¤±è´¥
        </div>
        
        <div class="actions">
            <button onclick="emergencyFix()" class="success">ğŸš€ ç´§æ€¥ä¿®å¤ - è·³è¿‡loading</button>
            <button onclick="clearAndRestart()" class="warning">ğŸ”„ æ¸…é™¤çŠ¶æ€é‡æ–°ç™»å½•</button>
            <button onclick="forceProfile()" class="warning">ğŸ’ª å¼ºåˆ¶è®¾ç½®Profile</button>
            <button onclick="directToStudent()">â¡ï¸ ç›´æ¥è¿›å…¥å­¦å‘˜ç•Œé¢</button>
        </div>
        
        <div id="status" class="status"></div>
        
        <div id="log" class="log" style="display: none;">
            <div id="log-content"></div>
        </div>
        
        <div class="info">
            <strong>ç´§æ€¥ä¿®å¤æ­¥éª¤ï¼š</strong><br>
            1. <strong>ç´§æ€¥ä¿®å¤</strong> - å¼ºåˆ¶è®¾ç½®loading=falseï¼Œè·³è¿‡å¡ä½çš„è¯·æ±‚<br>
            2. <strong>æ¸…é™¤çŠ¶æ€é‡æ–°ç™»å½•</strong> - å®Œå…¨é‡ç½®ï¼Œé‡æ–°å¼€å§‹<br>
            3. <strong>å¼ºåˆ¶è®¾ç½®Profile</strong> - æ‰‹åŠ¨è®¾ç½®ç”¨æˆ·èµ„æ–™<br>
            4. <strong>ç›´æ¥è¿›å…¥å­¦å‘˜ç•Œé¢</strong> - ç»•è¿‡è®¤è¯ç›´æ¥è·³è½¬
        </div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            
            logContent.textContent += `[${timestamp}] ${message}\n`;
            logDiv.style.display = 'block';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showStatus(message, type = 'success') {
            const status = document.getElementById('status');
            status.className = `status show ${type}`;
            status.textContent = message;
            setTimeout(() => {
                status.classList.remove('show');
            }, 3000);
        }

        function emergencyFix() {
            log('=== ç´§æ€¥ä¿®å¤ - è·³è¿‡loading ===');
            showStatus('æ­£åœ¨æ‰§è¡Œç´§æ€¥ä¿®å¤...', 'success');
            
            // å¼ºåˆ¶è®¾ç½®å®Œæ•´çš„è®¤è¯çŠ¶æ€
            localStorage.setItem('auth_token', 'student_auth_token');
            localStorage.setItem('user_role', 'student');
            localStorage.setItem('user_email', 'student@test.com');
            localStorage.setItem('user_id', 'student-1');
            localStorage.setItem('selectedSessionId', '3aec32c0-11f9-4dd4-935e-67b3b8b20974');
            localStorage.setItem('login_time', new Date().toISOString());
            localStorage.setItem('emergency_fix', 'true'); // æ ‡è®°ç´§æ€¥ä¿®å¤
            
            log('âœ… å¼ºåˆ¶è®¾ç½®è®¤è¯çŠ¶æ€å®Œæˆ');
            log('âœ… è®¾ç½®æœŸæ¬¡é€‰æ‹©å®Œæˆ');
            log('âœ… æ·»åŠ ç´§æ€¥ä¿®å¤æ ‡è®°');
            
            // å¼ºåˆ¶è·³è½¬åˆ°å­¦å‘˜Dashboardï¼Œç»•è¿‡loading
            log('ğŸš€ ç›´æ¥è·³è½¬åˆ°å­¦å‘˜Dashboard');
            setTimeout(() => {
                window.location.href = '/student/dashboard';
            }, 1000);
            
            showStatus('ç´§æ€¥ä¿®å¤å®Œæˆï¼Œæ­£åœ¨è·³è½¬...', 'success');
        }

        function clearAndRestart() {
            log('=== æ¸…é™¤çŠ¶æ€é‡æ–°ç™»å½• ===');
            showStatus('æ­£åœ¨æ¸…é™¤çŠ¶æ€...', 'warning');
            
            // æ¸…é™¤æ‰€æœ‰ç›¸å…³çŠ¶æ€
            localStorage.clear();
            sessionStorage.clear();
            
            // æ¸…é™¤IndexedDBä¸­çš„Supabaseæ•°æ®
            try {
                indexedDB.deleteDatabase('supabase-js-db');
                log('âœ… æ¸…é™¤Supabaseæ•°æ®åº“');
            } catch (e) {
                log('âš ï¸ æ¸…é™¤æ•°æ®åº“å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ');
            }
            
            log('âœ… æ¸…é™¤æ‰€æœ‰å­˜å‚¨æ•°æ®å®Œæˆ');
            
            // è·³è½¬åˆ°ç™»å½•é¡µé¢
            setTimeout(() => {
                window.location.href = '/student-login';
            }, 1500);
            
            showStatus('çŠ¶æ€æ¸…é™¤å®Œæˆï¼Œæ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µ...', 'success');
        }

        function forceProfile() {
            log('=== å¼ºåˆ¶è®¾ç½®Profile ===');
            showStatus('æ­£åœ¨å¼ºåˆ¶è®¾ç½®Profile...', 'warning');
            
            // è®¾ç½®å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯
            const userProfile = {
                id: 'student-1',
                email: 'student@test.com',
                full_name: 'Test Student',
                role: 'student',
                avatar_url: null,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            localStorage.setItem('auth_token', 'student_auth_token');
            localStorage.setItem('user_role', 'student');
            localStorage.setItem('user_email', 'student@test.com');
            localStorage.setItem('user_profile', JSON.stringify(userProfile));
            localStorage.setItem('selectedSessionId', '3aec32c0-11f9-4dd4-935e-67b3b8b20974');
            localStorage.setItem('force_profile', 'true'); // æ ‡è®°å¼ºåˆ¶Profile
            
            log('âœ… å¼ºåˆ¶è®¾ç½®Profileå®Œæˆ');
            log('âœ… è®¾ç½®ç”¨æˆ·è§’è‰²: student');
            log('âœ… è®¾ç½®æœŸæ¬¡é€‰æ‹©å®Œæˆ');
            
            setTimeout(() => {
                window.location.href = '/student/dashboard';
            }, 1000);
            
            showStatus('Profileè®¾ç½®å®Œæˆï¼Œæ­£åœ¨è·³è½¬...', 'success');
        }

        function directToStudent() {
            log('=== ç›´æ¥è¿›å…¥å­¦å‘˜ç•Œé¢ ===');
            showStatus('æ­£åœ¨ç›´æ¥è·³è½¬...', 'success');
            
            // æœ€å°åŒ–è®¾ç½®ï¼Œç›´æ¥è·³è½¬
            localStorage.setItem('emergency_access', 'true');
            localStorage.setItem('user_role', 'student');
            localStorage.setItem('selectedSessionId', '3aec32c0-11f9-4dd4-935e-67b3b8b20974');
            
            log('âœ… è®¾ç½®ç´§æ€¥è®¿é—®æ¨¡å¼');
            
            setTimeout(() => {
                window.location.href = '/student';
            }, 500);
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºå½“å‰çŠ¶æ€
        window.onload = function() {
            log('=== å½“å‰çŠ¶æ€æ£€æŸ¥ ===');
            
            const authToken = localStorage.getItem('auth_token');
            const userRole = localStorage.getItem('user_role');
            const userEmail = localStorage.getItem('user_email');
            const selectedSession = localStorage.getItem('selectedSessionId');
            
            log(`è®¤è¯ä»¤ç‰Œ: ${authToken ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
            log(`ç”¨æˆ·è§’è‰²: ${userRole || 'æœªè®¾ç½®'}`);
            log(`ç”¨æˆ·é‚®ç®±: ${userEmail || 'æœªè®¾ç½®'}`);
            log(`é€‰æ‹©æœŸæ¬¡: ${selectedSession || 'æœªè®¾ç½®'}`);
            log(`å½“å‰URL: ${window.location.href}`);
        };
    </script>
</body>
</html>
