<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½•ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
            width: 100%;
        }
        button:hover {
            background: #0056b3;
        }
        .success {
            background: #28a745;
        }
        .success:hover {
            background: #1e7e34;
        }
        .status {
            margin: 10px 0;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        .status.show {
            display: block;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .fix-summary {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ç™»å½•è¶…æ—¶ä¿®å¤æµ‹è¯•</h1>
        
        <div class="fix-summary">
            <h3>ğŸ¯ å·²ä¿®å¤çš„é—®é¢˜ï¼š</h3>
            <ul>
                <li>âŒ <strong>ç§»é™¤profilesè¡¨æ’å…¥æ“ä½œ</strong> - é¿å…RLSæƒé™å¯¼è‡´çš„è¶…æ—¶</li>
                <li>â±ï¸ <strong>æ·»åŠ æ•°æ®åº“æŸ¥è¯¢è¶…æ—¶</strong> - authorized_userså’ŒprofilesæŸ¥è¯¢2ç§’è¶…æ—¶</li>
                <li>ğŸ’¾ <strong>ä¼˜å…ˆä½¿ç”¨ç¼“å­˜è§’è‰²</strong> - å‡å°‘ä¸å¿…è¦çš„æ•°æ®åº“æŸ¥è¯¢</li>
                <li>ğŸš€ <strong>å¼ºåˆ¶ç»“æŸloading</strong> - ç¡®ä¿AuthContextä¸ä¼šæ— é™loading</li>
            </ul>
        </div>
        
        <div class="info">
            <strong>æµ‹è¯•è¯´æ˜ï¼š</strong><br>
            ç°åœ¨`UserService.getCurrentUser()`åº”è¯¥åœ¨4ç§’å†…å®Œæˆï¼ˆ2ç§’æŸ¥è¯¢è¶…æ—¶ Ã— 2ä¸ªæŸ¥è¯¢ï¼‰ï¼Œä¸å†å‡ºç°æ— é™è¶…æ—¶ã€‚
        </div>
        
        <div class="actions">
            <button onclick="testCurrentFix()" class="success">ğŸ§ª æµ‹è¯•å½“å‰ä¿®å¤</button>
            <button onclick="clearAndRelogin()">ğŸ”„ æ¸…é™¤çŠ¶æ€é‡æ–°ç™»å½•</button>
            <button onclick="simulateLogin()">âš¡ æ¨¡æ‹Ÿæ­£å¸¸ç™»å½•æµç¨‹</button>
            <button onclick="directToStudent()">â¡ï¸ ç›´æ¥è¿›å…¥å­¦å‘˜ç•Œé¢</button>
        </div>
        
        <div id="status" class="status"></div>
        
        <div id="log" class="log" style="display: none;">
            <div id="log-content"></div>
        </div>
        
        <div class="info">
            <strong>é¢„æœŸç»“æœï¼š</strong><br>
            âœ… UserService.getCurrentUser()åœ¨2-4ç§’å†…å®Œæˆ<br>
            âœ… Consoleæ˜¾ç¤º"ä½¿ç”¨ç¼“å­˜è§’è‰²"æˆ–"æŸ¥è¯¢è¶…æ—¶"<br>
            âœ… AuthContext loadingå˜ä¸ºfalse<br>
            âœ… æˆåŠŸè¿›å…¥å­¦å‘˜ç•Œé¢
        </div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            
            logContent.textContent += `[${timestamp}] ${message}\n`;
            logDiv.style.display = 'block';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showStatus(message, type = 'success') {
            const status = document.getElementById('status');
            status.className = `status show ${type}`;
            status.textContent = message;
            setTimeout(() => {
                status.classList.remove('show');
            }, 5000);
        }

        function testCurrentFix() {
            log('=== æµ‹è¯•å½“å‰ä¿®å¤æ•ˆæœ ===');
            showStatus('å¼€å§‹æµ‹è¯•ä¿®å¤æ•ˆæœ...', 'success');
            
            // ç¡®ä¿æœ‰åŸºæœ¬çš„è®¤è¯çŠ¶æ€
            localStorage.setItem('user_role', 'student');
            localStorage.setItem('user_email', 'student@test.com');
            localStorage.setItem('selectedSessionId', '3aec32c0-11f9-4dd4-935e-67b3b8b20974');
            
            log('âœ… è®¾ç½®ç¼“å­˜è§’è‰²: student');
            log('âœ… è®¾ç½®ç”¨æˆ·é‚®ç®±: student@test.com');
            log('âœ… è®¾ç½®æœŸæ¬¡é€‰æ‹©');
            
            // æ¸…é™¤ç´§æ€¥ä¿®å¤æ ‡è®°ï¼Œæµ‹è¯•æ­£å¸¸æµç¨‹
            localStorage.removeItem('emergency_fix');
            localStorage.removeItem('force_profile');
            log('âœ… æ¸…é™¤ç´§æ€¥ä¿®å¤æ ‡è®°ï¼Œæµ‹è¯•æ­£å¸¸æµç¨‹');
            
            // åˆ·æ–°é¡µé¢ï¼Œè§‚å¯Ÿä¿®å¤æ•ˆæœ
            log('ğŸ”„ åˆ·æ–°é¡µé¢ï¼Œè§‚å¯Ÿä¿®å¤æ•ˆæœ...');
            log('â±ï¸ é¢„æœŸï¼šUserService.getCurrentUser()åº”è¯¥åœ¨4ç§’å†…å®Œæˆ');
            
            setTimeout(() => {
                window.location.reload();
            }, 1000);
            
            showStatus('æµ‹è¯•è®¾ç½®å®Œæˆï¼Œå³å°†åˆ·æ–°é¡µé¢...', 'success');
        }

        function clearAndRelogin() {
            log('=== æ¸…é™¤çŠ¶æ€é‡æ–°ç™»å½• ===');
            showStatus('æ­£åœ¨æ¸…é™¤çŠ¶æ€...', 'success');
            
            // æ¸…é™¤æ‰€æœ‰çŠ¶æ€
            localStorage.clear();
            sessionStorage.clear();
            
            log('âœ… æ¸…é™¤æ‰€æœ‰å­˜å‚¨æ•°æ®');
            
            setTimeout(() => {
                window.location.href = '/student-login';
            }, 1000);
            
            showStatus('çŠ¶æ€æ¸…é™¤å®Œæˆï¼Œè·³è½¬åˆ°ç™»å½•é¡µ...', 'success');
        }

        function simulateLogin() {
            log('=== æ¨¡æ‹Ÿæ­£å¸¸ç™»å½•æµç¨‹ ===');
            showStatus('æ¨¡æ‹Ÿç™»å½•æµç¨‹...', 'success');
            
            // è®¾ç½®å®Œæ•´çš„ç™»å½•çŠ¶æ€
            localStorage.setItem('auth_token', 'student_auth_token');
            localStorage.setItem('user_role', 'student');
            localStorage.setItem('user_email', 'student@test.com');
            localStorage.setItem('user_id', 'student-1');
            localStorage.setItem('selectedSessionId', '3aec32c0-11f9-4dd4-935e-67b3b8b20974');
            localStorage.setItem('login_time', new Date().toISOString());
            
            log('âœ… è®¾ç½®è®¤è¯ä»¤ç‰Œ');
            log('âœ… è®¾ç½®ç”¨æˆ·è§’è‰²: student');
            log('âœ… è®¾ç½®ç”¨æˆ·ä¿¡æ¯');
            log('âœ… è®¾ç½®æœŸæ¬¡é€‰æ‹©');
            
            // è·³è½¬åˆ°ä¸»é¡µï¼Œè®©è·¯ç”±ä¿æŠ¤å¤„ç†
            setTimeout(() => {
                window.location.href = '/';
            }, 1000);
            
            showStatus('ç™»å½•çŠ¶æ€è®¾ç½®å®Œæˆï¼Œè·³è½¬åˆ°ä¸»é¡µ...', 'success');
        }

        function directToStudent() {
            log('=== ç›´æ¥è¿›å…¥å­¦å‘˜ç•Œé¢ ===');
            showStatus('ç›´æ¥è·³è½¬åˆ°å­¦å‘˜ç•Œé¢...', 'success');
            
            // æœ€ç®€åŒ–è®¾ç½®
            localStorage.setItem('user_role', 'student');
            localStorage.setItem('selectedSessionId', '3aec32c0-11f9-4dd4-935e-67b3b8b20974');
            
            setTimeout(() => {
                window.location.href = '/student/dashboard';
            }, 500);
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºå½“å‰çŠ¶æ€
        window.onload = function() {
            log('=== å½“å‰ç™»å½•ä¿®å¤çŠ¶æ€ ===');
            
            const authToken = localStorage.getItem('auth_token');
            const userRole = localStorage.getItem('user_role');
            const userEmail = localStorage.getItem('user_email');
            const emergencyFix = localStorage.getItem('emergency_fix');
            const forceProfile = localStorage.getItem('force_profile');
            
            log(`è®¤è¯ä»¤ç‰Œ: ${authToken ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
            log(`ç”¨æˆ·è§’è‰²: ${userRole || 'æœªè®¾ç½®'}`);
            log(`ç”¨æˆ·é‚®ç®±: ${userEmail || 'æœªè®¾ç½®'}`);
            log(`ç´§æ€¥ä¿®å¤æ ‡è®°: ${emergencyFix || 'æ— '}`);
            log(`å¼ºåˆ¶Profileæ ‡è®°: ${forceProfile || 'æ— '}`);
            log(`å½“å‰URL: ${window.location.href}`);
            
            if (userRole) {
                log('âœ… å·²æœ‰ç¼“å­˜è§’è‰²ï¼ŒUserServiceåº”è¯¥è·³è¿‡æ•°æ®åº“æŸ¥è¯¢');
            } else {
                log('âš ï¸ æ— ç¼“å­˜è§’è‰²ï¼ŒUserServiceä¼šæŸ¥è¯¢æ•°æ®åº“ï¼ˆå¸¦è¶…æ—¶ä¿æŠ¤ï¼‰');
            }
        };
    </script>
</body>
</html>
